<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>claude</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: monospace;
      background: #0a0a0a;
      color: #ccc;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      font-size: 14px;
    }
    .container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .settings {
      background: #0d0d0d;
      border: 1px solid #333;
      border-bottom: none;
      padding: 10px 12px;
      display: none;
    }
    .settings.open { display: block; }
    .settings h3 { color: #888; font-size: 12px; margin-bottom: 8px; }
    .settings-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .settings-row label {
      color: #666;
      font-size: 11px;
      width: 60px;
      text-align: right;
    }
    .settings-row input {
      flex: 1;
      min-width: 120px;
      background: #111;
      border: 1px solid #333;
      color: #ccc;
      padding: 4px 8px;
      font-family: monospace;
      font-size: 12px;
      outline: none;
    }
    .settings-row input:focus { border-color: #555; }
    .settings-row button {
      background: #1a3a1a;
      border: 1px solid #2a5a2a;
      color: #6a6;
      padding: 4px 14px;
      font-family: monospace;
      font-size: 12px;
      cursor: pointer;
    }
    .settings-row button:hover { background: #2a4a2a; color: #8c8; }
    .conn-status {
      font-size: 11px;
      padding: 4px 0;
    }
    .conn-status.ok { color: #6a6; }
    .conn-status.err { color: #a66; }
    .conn-status.pending { color: #aa6; }

    .bar {
      background: #111;
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      border: 1px solid #333;
      border-bottom: none;
      flex-wrap: wrap;
      align-items: center;
    }
    .bar button {
      background: #1a1a1a;
      border: 1px solid #444;
      color: #888;
      padding: 4px 12px;
      font-family: monospace;
      font-size: 12px;
      cursor: pointer;
    }
    .bar button:hover { background: #2a2a2a; color: #fff; }
    .bar button.danger { border-color: #533; color: #a66; }
    .bar button.danger:hover { background: #322; }
    .bar button.settings-btn { border-color: #353; color: #686; }
    .bar button.settings-btn.active { background: #1a2a1a; color: #6a6; border-color: #4a4; }
    .bar .status { margin-left: auto; color: #555; font-size: 11px; }
    .bar .status.ok { color: #6a6; }
    .bar .status.err { color: #a66; }

    .terminal {
      flex: 1;
      background: #000;
      border: 1px solid #333;
      padding: 12px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 13px;
      line-height: 1.4;
      min-height: 300px;
      max-height: 60vh;
    }

    .input-bar {
      background: #111;
      border: 1px solid #333;
      border-top: none;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .prompt { color: #6a6; }
    #mobileInput {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      font-family: monospace;
      font-size: 14px;
      outline: none;
      caret-color: #6a6;
    }

    .keys {
      background: #111;
      padding: 8px 12px;
      display: flex;
      gap: 6px;
      border: 1px solid #333;
      border-top: none;
      flex-wrap: wrap;
    }
    .keys button {
      background: #1a1a1a;
      border: 1px solid #333;
      color: #666;
      padding: 4px 10px;
      font-family: monospace;
      font-size: 11px;
      cursor: pointer;
    }
    .keys button:hover { background: #2a2a2a; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="settings" id="settingsPanel">
      <h3>SSH Connection</h3>
      <div class="settings-row">
        <label>host</label>
        <input type="text" id="sshHost" placeholder="192.168.8.116">
        <label>user</label>
        <input type="text" id="sshUser" placeholder="tim">
      </div>
      <div class="settings-row">
        <label>pass</label>
        <input type="password" id="sshPass" placeholder="password">
        <button onclick="saveConfig()">connect</button>
      </div>
      <div class="conn-status" id="connStatus"></div>
    </div>

    <div class="bar">
      <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">ssh</button>
      <button onclick="api('new')">new</button>
      <button onclick="api('resume')">resume</button>
      <button onclick="getOutput()">sync</button>
      <button class="danger" onclick="key('ctrl-c')">^C</button>
      <button onclick="api('kill')">kill</button>
      <span class="status" id="status">ready</span>
    </div>

    <pre class="terminal" id="terminal" onclick="mobileInput.focus()">Claude Terminal
---
Configure SSH connection first:
  1. Click [ssh] to open settings
  2. Enter host IP, username, password
  3. Click [connect] to test
  4. Then [new] to start Claude</pre>

    <div class="input-bar" onclick="mobileInput.focus()">
      <span class="prompt">&gt;</span>
      <input type="text" id="mobileInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>

    <div class="keys">
      <button onclick="key('up')">up</button>
      <button onclick="key('down')">dn</button>
      <button onclick="key('left')">lt</button>
      <button onclick="key('right')">rt</button>
      <button onclick="key('escape')">esc</button>
      <button onclick="key('tab')">tab</button>
      <button onclick="key('backspace')">bksp</button>
      <button onclick="key('enter')">enter</button>
    </div>
  </div>

  <script>
    const B = window.location.pathname.replace(/\/?$/, '/');
    const terminal = document.getElementById('terminal');
    const inp = document.getElementById('mobileInput');
    const status = document.getElementById('status');
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsBtn = document.getElementById('settingsBtn');
    const connStatus = document.getElementById('connStatus');

    function st(t, c) {
      status.textContent = t;
      status.className = 'status ' + (c || '');
    }

    function toggleSettings() {
      settingsPanel.classList.toggle('open');
      settingsBtn.classList.toggle('active');
    }

    // Load saved config from localStorage
    function loadSaved() {
      const saved = localStorage.getItem('claude-ssh');
      if (saved) {
        try {
          const c = JSON.parse(saved);
          document.getElementById('sshHost').value = c.host || '';
          document.getElementById('sshUser').value = c.user || '';
          document.getElementById('sshPass').value = c.pass || '';
        } catch {}
      }
    }

    async function saveConfig() {
      const host = document.getElementById('sshHost').value.trim();
      const user = document.getElementById('sshUser').value.trim();
      const pass = document.getElementById('sshPass').value;

      if (!host || !user) {
        connStatus.textContent = 'host and user required';
        connStatus.className = 'conn-status err';
        return;
      }

      connStatus.textContent = 'connecting...';
      connStatus.className = 'conn-status pending';

      try {
        const r = await fetch(B + 'api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ host, user, pass })
        });
        const d = await r.json();

        if (d.ok) {
          connStatus.textContent = 'connected to ' + user + '@' + host;
          connStatus.className = 'conn-status ok';
          localStorage.setItem('claude-ssh', JSON.stringify({ host, user, pass }));
          st('connected', 'ok');
          terminal.textContent = 'Connected to ' + user + '@' + host + '\n---\n[new]    start fresh Claude session\n[resume] continue previous session\n[^C]     interrupt\n[kill]   end session';
        } else {
          connStatus.textContent = 'failed: ' + (d.error || 'unknown error');
          connStatus.className = 'conn-status err';
          st('not connected', 'err');
        }
      } catch (e) {
        connStatus.textContent = 'error: ' + e.message;
        connStatus.className = 'conn-status err';
      }
    }

    // Auto-connect on load if saved
    async function autoConnect() {
      loadSaved();
      const host = document.getElementById('sshHost').value;
      const user = document.getElementById('sshUser').value;
      const pass = document.getElementById('sshPass').value;
      if (host && user && pass) {
        await saveConfig();
      } else {
        // Show settings panel if no saved config
        settingsPanel.classList.add('open');
        settingsBtn.classList.add('active');
      }
    }

    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (inp.value) {
          send(inp.value);
          inp.value = '';
          setTimeout(getOutput, 500);
        } else {
          key('enter');
        }
        return;
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        key('ctrl-c');
        return;
      }
    });

    document.addEventListener('keydown', (e) => {
      if (document.activeElement === inp) return;
      if (document.activeElement.tagName === 'INPUT') return;

      const navKeys = {
        'ArrowUp': 'up', 'ArrowDown': 'down',
        'ArrowLeft': 'left', 'ArrowRight': 'right',
        'Escape': 'escape', 'Tab': 'tab'
      };
      if (navKeys[e.key]) {
        e.preventDefault();
        key(navKeys[e.key]);
        return;
      }
      if (e.key === ' ') {
        e.preventDefault();
        key('space');
        return;
      }
      if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
        inp.focus();
      }
    });

    async function api(e) {
      st(e + '...', '');
      try {
        const r = await fetch(B + 'api/' + e, { method: 'POST' });
        const d = await r.json();
        st(d.ok ? 'ok' : (d.error || 'err'), d.ok ? 'ok' : 'err');
        if (d.ok) setTimeout(getOutput, 1500);
      } catch (e) { st('err', 'err'); }
    }

    async function send(text) {
      st('send...', '');
      try {
        const r = await fetch(B + 'api/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const d = await r.json();
        st(d.ok ? 'sent' : 'err', d.ok ? 'ok' : 'err');
      } catch (e) { st('err', 'err'); }
    }

    async function key(k) {
      st(k, '');
      try {
        const r = await fetch(B + 'api/key', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: k })
        });
        const d = await r.json();
        st(d.ok ? 'ok' : 'err', d.ok ? 'ok' : 'err');
        if (d.ok) setTimeout(getOutput, 200);
      } catch (e) { st('err', 'err'); }
    }

    async function getOutput() {
      st('sync...', '');
      try {
        const r = await fetch(B + 'api/output');
        const d = await r.json();
        if (d.ok && d.output) {
          terminal.textContent = d.output;
          st('synced', 'ok');
        } else {
          st(d.error || 'no output', d.ok ? '' : 'err');
        }
      } catch (e) { st('err', 'err'); }
    }

    autoConnect();
  </script>
</body>
</html>
